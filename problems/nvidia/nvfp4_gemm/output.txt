python3 debug_scale_layouts.py
Testing with M=128, N=256, K=256, L=1
sfa_ref_cpu shape: torch.Size([128, 16, 1])
sfa_permuted shape: torch.Size([32, 4, 1, 4, 4, 1])

to_blocked output shape: torch.Size([2048])
sfa_permuted flattened shape: torch.Size([2048])
Total bytes match: True

Blocked bytes shape: torch.Size([2048])
Permuted bytes shape: torch.Size([2048])

Byte comparison: 540/2048 bytes match (26.37%)
First 20 mismatch indices: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, 19, 21, 22, 23]
  Index 2: blocked=56, permuted=0
  Index 3: blocked=68, permuted=56
  Index 4: blocked=64, permuted=56
  Index 5: blocked=56, permuted=0
  Index 6: blocked=64, permuted=56

First 64 bytes of to_blocked:
[56, 56, 56, 68, 64, 56, 64, 64, 68, 0, 68, 64, 68, 0, 68, 68, 0, 68, 64, 56, 56, 0, 56, 56, 0, 0, 0, 68, 68, 56, 56, 0, 68, 56, 68, 0, 68, 68, 68, 64, 0, 68, 68, 64, 56, 68, 68, 68, 68, 0, 68, 56, 56, 64, 0, 0, 56, 56, 56, 68, 68, 0, 56, 0]

First 64 bytes of sfa_permuted.flatten():
[56, 56, 0, 56, 56, 0, 56, 56, 56, 56, 0, 68, 68, 64, 56, 0, 64, 56, 56, 0, 56, 64, 68, 68, 64, 68, 68, 56, 64, 68, 0, 0, 68, 68, 68, 68, 0, 64, 56, 0, 68, 56, 0, 0, 64, 0, 68, 56, 68, 64, 0, 0, 0, 0, 68, 68, 68, 68, 68, 64, 68, 68, 0, 68]

--- Tile Structure Analysis ---
M = 128, K_scales = 16
sfa_ref_cpu[0:4, 0:4] (first 4x4 corner):
[[56, 56, 56, 68], [0, 68, 64, 56], [68, 56, 68, 0], [68, 0, 68, 56]]

to_blocked intermediate shapes:
  view(1, 128, 4, 4) -> permute(0,2,1,3)
  -> reshape(-1, 4, 32, 4) -> transpose(1, 2)
  -> reshape(-1, 32, 16) -> flatten()

sfa_permuted 6D layout: (32, 4, rest_m, 4, rest_k)
  rest_m = 1, rest_k = 4
  Total elements = 32 * 4 * 1 * 4 * 4 = 2048

Sampling specific positions:
  m=  0, k= 0: ref= 56, perm[0,0,0,0,0]= 56 ✓
  m=  0, k= 3: ref= 68, perm[0,0,0,3,0]= 68 ✓
  m=  0, k= 4: ref= 56, perm[0,0,0,0,1]= 56 ✓
  m=  0, k=15: ref=  0, perm[0,0,0,3,3]=  0 ✓
  m= 31, k= 0: ref= 56, perm[31,0,0,0,0]= 56 ✓
  m= 31, k= 3: ref=  0, perm[31,0,0,3,0]=  0 ✓
  m= 31, k= 4: ref= 64, perm[31,0,0,0,1]= 64 ✓
  m= 31, k=15: ref=  0, perm[31,0,0,3,3]=  0 ✓
  m= 32, k= 0: ref= 64, perm[0,1,0,0,0]= 64 ✓
  m= 32, k= 3: ref= 64, perm[0,1,0,3,0]= 64 ✓
  m= 32, k= 4: ref= 56, perm[0,1,0,0,1]= 56 ✓
  m= 32, k=15: ref=  0, perm[0,1,0,3,3]=  0 ✓
  m=127, k= 0: ref= 64, perm[31,3,0,0,0]= 64 ✓
  m=127, k= 3: ref=  0, perm[31,3,0,3,0]=  0 ✓
  m=127, k= 4: ref= 68, perm[31,3,0,0,1]= 68 ✓
  m=127, k=15: ref= 56, perm[31,3,0,3,3]= 56 ✓

python3 debug_permutation.py
Testing 128x16...
MATCH!